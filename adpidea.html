import React, { useMemo, useState } from "react";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Checkbox } from "@/components/ui/checkbox";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { Separator } from "@/components/ui/separator";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { AlertTriangle, CheckCircle2, Clock, Info, Pencil, Filter, Search, Bell, Bolt, Users } from "lucide-react";

/**
 * Termination Workflow — UI Visual (Prototype)
 * 
 * Goals covered:
 * - Main action: Assign terminations to a payroll (auto-assign to next regular period with ability to reassign / off-cycle)
 * - Optional actions clearly separated (DD end dates, end-dated records)
 * - Grouping by action required (Immediate vs. Leave as-is)
 * - Tabs for Required, Optional, Issues
 * - Alerts/Indicators for expedited/legal flags
 * - Clear labels (pay group, pay period, record type, end date, auto vs. editable)
 * - Bulk actions for review & reassignment
 */

const MOCK_PERIODS = [
  { id: "P2025-10-15", label: "Oct 15, 2025 — Regular", type: "regular" },
  { id: "P2025-10-08-OCP", label: "Oct 8, 2025 — Off-Cycle", type: "ocp" },
  { id: "P2025-10-22", label: "Oct 22, 2025 — Regular", type: "regular" },
];

const MOCK_DATA = [
  {
    id: "E1023",
    name: "Avery Johnson",
    payGroup: "Hourly — East (W1)",
    defaultPeriod: "P2025-10-15",
    endDate: "2025-10-02",
    type: "Involuntary",
    expedited: true,
    reason: "Legal hold window",
    ddEnds: "2025-10-02",
  },
  {
    id: "E2049",
    name: "Ben Torres",
    payGroup: "Salary — West (S2)",
    defaultPeriod: "P2025-10-15",
    endDate: "2025-10-01",
    type: "Voluntary",
    expedited: false,
    reason: "—",
    ddEnds: "2025-10-15",
  },
  {
    id: "E3188",
    name: "Chen Liu",
    payGroup: "Hourly — East (W1)",
    defaultPeriod: "P2025-10-15",
    endDate: "2025-10-02",
    type: "Involuntary",
    expedited: true,
    reason: "COBRA + state timing",
    ddEnds: "2025-10-02",
  },
  {
    id: "E4412",
    name: "Daria Petrov",
    payGroup: "Salary — Central (S3)",
    defaultPeriod: "P2025-10-15",
    endDate: "2025-10-03",
    type: "Voluntary",
    expedited: false,
    reason: "—",
    ddEnds: "2025-10-15",
  },
];

function PeriodBadge({ id }: { id: string }) {
  const meta = useMemo(() => MOCK_PERIODS.find((p) => p.id === id), [id]);
  if (!meta) return <Badge variant="secondary">Unknown</Badge>;
  return (
    <Badge className="font-medium" variant={meta.type === "ocp" ? "destructive" : "default"}>
      {meta.label}
    </Badge>
  );
}

function ExpeditedIndicator({ show, reason }: { show: boolean; reason?: string }) {
  if (!show) return null;
  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <div className="inline-flex items-center gap-1 rounded-full px-2 py-1 bg-red-50 border border-red-200">
            <Bolt className="h-4 w-4" />
            <span className="text-xs font-semibold text-red-700">Expedite</span>
          </div>
        </TooltipTrigger>
        <TooltipContent>
          <p className="max-w-xs text-xs">{reason || "Requires expedited payment due to policy/flag"}</p>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}

export default function TerminationWorkflowVisual() {
  const [tab, setTab] = useState("required");
  const [query, setQuery] = useState("");
  const [ocpMode, setOcpMode] = useState(false);
  const [selection, setSelection] = useState<string[]>([]);
  const [periodByEmp, setPeriodByEmp] = useState<Record<string, string>>(
    Object.fromEntries(MOCK_DATA.map((e) => [e.id, e.defaultPeriod]))
  );

  const filtered = useMemo(() => {
    return MOCK_DATA.filter(
      (r) => r.name.toLowerCase().includes(query.toLowerCase()) || r.id.toLowerCase().includes(query.toLowerCase())
    );
  }, [query]);

  const immediate = filtered.filter((r) => r.expedited || r.type === "Involuntary");
  const leaveAsIs = filtered.filter((r) => !immediate.includes(r));

  const toggleSelectAll = (rows: typeof MOCK_DATA) => {
    const ids = rows.map((r) => r.id);
    const allSelected = ids.every((id) => selection.includes(id));
    setSelection(allSelected ? selection.filter((id) => !ids.includes(id)) : Array.from(new Set([...selection, ...ids])));
  };

  const bulkReassign = (periodId: string) => {
    const update: Record<string, string> = {};
    selection.forEach((id) => (update[id] = periodId));
    setPeriodByEmp((prev) => ({ ...prev, ...update }));
  };

  return (
    <div className="p-6 md:p-10 bg-gradient-to-b from-slate-50 to-white text-slate-900 min-h-screen">
      <div className="mb-6 flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">Terminate & Assign to Payroll</h1>
          <p className="text-sm text-slate-600 mt-1">Required actions first. Optional reviews are available without blocking submission.</p>
        </div>
        <div className="flex items-center gap-3">
          <div className="flex items-center gap-2 rounded-2xl border p-2 pr-3 shadow-sm bg-white">
            <div className="px-2 py-1 rounded-xl bg-slate-100 text-xs font-medium">Auto‑assign</div>
            <Info className="h-4 w-4" />
            <span className="text-sm text-slate-700">Next Regular Period (editable)</span>
          </div>
          <div className="flex items-center gap-2 rounded-2xl border p-3 shadow-sm bg-white">
            <Switch checked={ocpMode} onCheckedChange={setOcpMode} id="ocp" />
            <label htmlFor="ocp" className="text-sm font-medium">Enable Off‑Cycle (OCP)</label>
          </div>
        </div>
      </div>

      <Card className="mb-6">
        <CardHeader className="pb-2">
          <CardTitle className="text-base flex items-center gap-2"><Filter className="h-4 w-4"/> Filters & Bulk Actions</CardTitle>
          <CardDescription>Search employees, then apply bulk reassignment or acknowledge proration (if applicable).</CardDescription>
        </CardHeader>
        <CardContent className="flex flex-col md:flex-row gap-3 md:items-center">
          <div className="relative max-w-sm w-full">
            <Search className="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2"/>
            <Input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="Search by name or ID" className="pl-9"/>
          </div>
          <Separator orientation="vertical" className="hidden md:block"/>
          <div className="flex items-center gap-2">
            <Select onValueChange={(v)=> bulkReassign(v)}>
              <SelectTrigger className="w-64">
                <SelectValue placeholder="Bulk reassign selected to…" />
              </SelectTrigger>
              <SelectContent>
                {MOCK_PERIODS.map(p => (
                  <SelectItem key={p.id} value={p.id}>{p.label}</SelectItem>
                ))}
              </SelectContent>
            </Select>
            <Button variant="outline" disabled={selection.length===0}>Reassign</Button>
            <Button variant="secondary" disabled={selection.length===0}>Acknowledge Proration</Button>
            <div className="text-xs text-slate-600 ml-1">{selection.length} selected</div>
          </div>
        </CardContent>
      </Card>

      <Tabs value={tab} onValueChange={setTab} className="w-full">
        <TabsList className="grid grid-cols-3 w-full md:w-auto">
          <TabsTrigger value="required" className="gap-2">
            <Users className="h-4 w-4"/> Required Actions
          </TabsTrigger>
          <TabsTrigger value="optional" className="gap-2">
            <CheckCircle2 className="h-4 w-4"/> Optional Review
          </TabsTrigger>
          <TabsTrigger value="issues" className="gap-2">
            <AlertTriangle className="h-4 w-4"/> Termination Issues
          </TabsTrigger>
        </TabsList>

        {/* REQUIRED TAB */}
        <TabsContent value="required" className="mt-5">
          <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
            {/* Immediate Attention */}
            <Card className="border-red-200">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Bell className="h-5 w-5"/>
                  Immediate Attention
                </CardTitle>
                <CardDescription>Involuntary or flagged terminations that may require expedited payment.</CardDescription>
              </CardHeader>
              <CardContent>
                <ActionTable
                  rows={immediate}
                  selection={selection}
                  setSelection={setSelection}
                  toggleSelectAll={()=>toggleSelectAll(immediate)}
                  periodByEmp={periodByEmp}
                  setPeriodByEmp={setPeriodByEmp}
                />
              </CardContent>
            </Card>

            {/* Leave As‑Is */}
            <Card>
              <CardHeader>
                <CardTitle>Leave As‑Is</CardTitle>
                <CardDescription>Auto‑assigned to next regular period. Adjust only if needed.</CardDescription>
              </CardHeader>
              <CardContent>
                <ActionTable
                  rows={leaveAsIs}
                  selection={selection}
                  setSelection={setSelection}
                  toggleSelectAll={()=>toggleSelectAll(leaveAsIs)}
                  periodByEmp={periodByEmp}
                  setPeriodByEmp={setPeriodByEmp}
                />
              </CardContent>
            </Card>
          </div>
        </TabsContent>

        {/* OPTIONAL TAB */}
        <TabsContent value="optional" className="mt-5">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <Card>
              <CardHeader>
                <CardTitle>Direct Deposit End Dates</CardTitle>
                <CardDescription>Optional review. Adjust if end dates need to be earlier than default.</CardDescription>
              </CardHeader>
              <CardContent>
                <OptionalTable rows={filtered} column="ddEnds" label="DD End"/>
              </CardContent>
            </Card>
            <Card>
              <CardHeader>
                <CardTitle>End‑Dated Records</CardTitle>
                <CardDescription>View-only summary of records that will be end‑dated with the termination.</CardDescription>
              </CardHeader>
              <CardContent>
                <ViewOnlyTable rows={filtered}/>
              </CardContent>
            </Card>
          </div>
        </TabsContent>

        {/* ISSUES TAB */}
        <TabsContent value="issues" className="mt-5">
          <Alert className="mb-4 border-amber-300">
            <AlertTriangle className="h-5 w-5" />
            <AlertTitle>Resolve before submission</AlertTitle>
            <AlertDescription>Some terminations require expedited payroll due to legal timing or HR policy. Reassign to an Off‑Cycle period or confirm next regular period is compliant.</AlertDescription>
          </Alert>
          <Card>
            <CardHeader>
              <CardTitle>Expedite Candidates</CardTitle>
              <CardDescription>Flagged by HR or compliance rules.</CardDescription>
            </CardHeader>
            <CardContent>
              <ActionTable
                rows={immediate}
                selection={selection}
                setSelection={setSelection}
                toggleSelectAll={()=>toggleSelectAll(immediate)}
                periodByEmp={periodByEmp}
                setPeriodByEmp={setPeriodByEmp}
              />
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      <FooterBar selectionCount={selection.length} />
    </div>
  );
}

function ActionTable({ rows, selection, setSelection, toggleSelectAll, periodByEmp, setPeriodByEmp }: any) {
  return (
    <div className="overflow-hidden rounded-2xl border bg-white shadow-sm">
      <table className="w-full text-sm">
        <thead className="bg-slate-50 text-slate-600">
          <tr>
            <th className="px-4 py-3 text-left w-10">
              <Checkbox
                checked={rows.length>0 && rows.every((r: any)=> selection.includes(r.id))}
                onCheckedChange={toggleSelectAll}
                aria-label="Select all"
              />
            </th>
            <th className="px-2 py-3 text-left">Employee</th>
            <th className="px-2 py-3 text-left">Pay Group</th>
            <th className="px-2 py-3 text-left">Pay Period</th>
            <th className="px-2 py-3 text-left">Type</th>
            <th className="px-2 py-3 text-left">End Date</th>
            <th className="px-2 py-3 text-left">Indicators</th>
            <th className="px-4 py-3 text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {rows.map((r: any) => (
            <tr key={r.id} className="border-t hover:bg-slate-50/60">
              <td className="px-4 py-3 align-top">
                <Checkbox
                  checked={selection.includes(r.id)}
                  onCheckedChange={(checked)=> setSelection((prev: string[]) => checked ? [...prev, r.id] : prev.filter((x)=> x!==r.id))}
                  aria-label={`Select ${r.name}`}
                />
              </td>
              <td className="px-2 py-3 align-top">
                <div className="font-medium">{r.name} <span className="text-xs text-slate-500 ml-1">#{r.id}</span></div>
                <div className="text-xs text-slate-500">Auto‑assigned to next regular period by default</div>
              </td>
              <td className="px-2 py-3 align-top">
                <Badge variant="outline">{r.payGroup}</Badge>
              </td>
              <td className="px-2 py-3 align-top">
                <div className="flex items-center gap-2">
                  <PeriodBadge id={periodByEmp[r.id]} />
                  <Select
                    value={periodByEmp[r.id]}
                    onValueChange={(v)=> setPeriodByEmp((prev: any)=> ({...prev, [r.id]: v}))}
                  >
                    <SelectTrigger className="h-8 w-9 md:w-56">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {MOCK_PERIODS.map(p => (
                        <SelectItem key={p.id} value={p.id}>
                          <div className="flex items-center gap-2">
                            {p.type === "regular" ? <Clock className="h-3.5 w-3.5"/> : <Bolt className="h-3.5 w-3.5"/>}
                            <span>{p.label}</span>
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </td>
              <td className="px-2 py-3 align-top">
                <Badge variant={r.type === "Involuntary" ? "destructive" : "secondary"}>{r.type}</Badge>
              </td>
              <td className="px-2 py-3 align-top">
                <div className="flex items-center gap-1"><CalendarDot /> {new Date(r.endDate).toLocaleDateString()}</div>
                <div className="text-xs text-slate-500">Record type: Termination</div>
              </td>
              <td className="px-2 py-3 align-top">
                <div className="flex items-center gap-2">
                  <ExpeditedIndicator show={r.expedited} reason={r.reason} />
                </div>
              </td>
              <td className="px-4 py-3 align-top text-right">
                <Button variant="ghost" size="icon" className="hover:bg-slate-100" aria-label="Edit">
                  <Pencil className="h-4 w-4" />
                </Button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      <div className="px-4 py-3 text-xs text-slate-600 bg-slate-50 flex items-center justify-between">
        <span>Changes apply immediately to the Off‑Cycle batch or next Regular period as shown.</span>
        <span className="flex items-center gap-1"><Info className="h-3.5 w-3.5"/> Proration prompts appear when sending associates to OCP.</span>
      </div>
    </div>
  );
}

function OptionalTable({ rows, column, label }: any) {
  return (
    <div className="overflow-hidden rounded-2xl border bg-white shadow-sm">
      <table className="w-full text-sm">
        <thead className="bg-slate-50 text-slate-600">
          <tr>
            <th className="px-4 py-3 text-left">Employee</th>
            <th className="px-2 py-3 text-left">{label}</th>
            <th className="px-2 py-3 text-left">Pay Group</th>
            <th className="px-2 py-3 text-left">Note</th>
          </tr>
        </thead>
        <tbody>
          {rows.map((r: any) => (
            <tr key={r.id} className="border-t hover:bg-slate-50/60">
              <td className="px-4 py-3">
                <div className="font-medium">{r.name} <span className="text-xs text-slate-500 ml-1">#{r.id}</span></div>
              </td>
              <td className="px-2 py-3">
                <div className="flex items-center gap-1"><CalendarDot /> {new Date(r[column]).toLocaleDateString()}</div>
              </td>
              <td className="px-2 py-3"><Badge variant="outline">{r.payGroup}</Badge></td>
              <td className="px-2 py-3 text-slate-500 text-xs">Optional — adjust only if banking access must end earlier</td>
            </tr>
          ))}
        </tbody>
      </table>
      <div className="px-4 py-3 text-xs text-slate-600 bg-slate-50">These settings do not block submission.</div>
    </div>
  );
}

function ViewOnlyTable({ rows }: any) {
  return (
    <div className="overflow-hidden rounded-2xl border bg-white shadow-sm">
      <table className="w-full text-sm">
        <thead className="bg-slate-50 text-slate-600">
          <tr>
            <th className="px-4 py-3 text-left">Employee</th>
            <th className="px-2 py-3 text-left">Record Type</th>
            <th className="px-2 py-3 text-left">End Date</th>
            <th className="px-2 py-3 text-left">Status</th>
          </tr>
        </thead>
        <tbody>
          {rows.map((r: any) => (
            <tr key={r.id} className="border-t hover:bg-slate-50/60">
              <td className="px-4 py-3">
                <div className="font-medium">{r.name}</div>
                <div className="text-xs text-slate-500">#{r.id}</div>
              </td>
              <td className="px-2 py-3">Direct Deposit, Deductions, Benefits</td>
              <td className="px-2 py-3"><div className="flex items-center gap-1"><CalendarDot /> {new Date(r.endDate).toLocaleDateString()}</div></td>
              <td className="px-2 py-3"><Badge variant="secondary">Will be End‑Dated</Badge></td>
            </tr>
          ))}
        </tbody>
      </table>
      <div className="px-4 py-3 text-xs text-slate-600 bg-slate-50">View‑only: sourced from system rules; no action required.</div>
    </div>
  );
}

function FooterBar({ selectionCount }: { selectionCount: number }) {
  return (
    <div className="sticky bottom-3 left-0 right-0 mx-auto max-w-6xl">
      <div className="rounded-2xl bg-white/90 backdrop-blur border shadow-lg px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-3 text-sm">
          <Badge variant="outline" className="rounded-xl">{selectionCount} selected</Badge>
          <span className="text-slate-600">Confirm assignments, then submit the terminations.</span>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline">Save Draft</Button>
          <Button className="bg-slate-900 text-white hover:bg-slate-800">Submit Terminations</Button>
        </div>
      </div>
    </div>
  );
}

function CalendarDot() {
  return (
    <svg viewBox="0 0 24 24" className="h-4 w-4" aria-hidden>
      <path d="M7 2a1 1 0 0 0-1 1v1H5a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3h-1V3a1 1 0 1 0-2 0v1H8V3a1 1 0 0 0-1-1Zm12 8H5v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-8Zm-9 5a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path>
    </svg>
  );
}
